---
toc: true
title: 春节之包体积优化
date: 2020-02-03 22:20:58
categories:
tags:
---

## 前言

这个春节真是有够长，蹭着没事来做一次MSDK包的优化，MSDK包太大已经被吐槽无数次了，前一段时候才做了把一些限飞数据库资源等变成可选项`bundle`让用户进行下载，甚至把一些功能打包成动态库用于动态加载，则不需要这些功能的用户可以不引入。

但是这还远远不够。当前MSDK编译出来的framework为159.6MB。看看优化后到底能缩小到多少。



## 分析

先看看`DJISDK.Framework`有哪些东西吧:

![image-20200203225942902](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200203225942902.png)

![image-20200203223509635](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200203223509635.png)

可以看到有几个除了动态库`DJISDK`还有几个`bundle`存放着一些资源文件。

### 1.去除无用文件

`xcode`的`build setting`中有一个叫`link map`的选项，当设置`write link map file`为`true`时，`link`的每一个文件都会被记录在`link map`文件下，路径可以参考`path to link map file`。通过这个文件就可以看到所有文件的信息，它把所有link进去的文件都列举了出来包括路径。而且有一个比较实用的GUI工具用于分析`linkmap`。地址为:https://www.jianshu.com/p/ea80df3d4212。它主要是遍历`linkmap`然后找到路径获取文件大小，然后按大小排列，可以方便我们一眼看出来各个文件的大小。

我们先做一个实验，创建一个工程并创建两个类，一个使用，另一个不使用，然后查看linkmap可以看到即使不使用两个目标文件都被link了。因此第一步应该想办法去掉没有使用的文件。这里有两个思路，第一个是查找所有没有被`import`或是`include`的文件。 第二个是考虑到基本我们创建的都是OC的类文件，因此想办法找出这些没有被使用过的类。好在`Mach-O`文件记录下了一切信息，在`__CONST_DATA`的`_objc_classlist section`保存了全部的类，而在`__DATA`的`_objc_classrefs`记录所有被引用的类，因此前者减去后者就可以知道哪些类没有被引用。但是秉承一切刨根问底的原则，我们还是以刚创建的工程编译出的`Mach-O`进行检验，利用`mach-o view`来观察:

`classlist`信息如下，可以通过`offset`找到对应的`section`，可以看出来`section`保存的只是`class`指针，并且共有`40/ sizeof(void *) = 5`个（当前为x86_64系统下）。

![image-20200204000949588](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200204000949588.png)

通过位移找到对应的`section`信息可以看到，由于`alignment`为8，所以共5个，每一个都是一个指针：

![image-20200204003827604](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200204003827604.png)

`classref`信息如下，可知被引用的`class`共有`24/ sizeof(void *) = 3`个：

![image-20200204001006392](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200204001006392.png)

我们通过`offset`找到对应的`section`，可以看到果然只有一下三个类被引用，包括我们使用的`TestClass1`,但是未使用的`TestClass2`就不在这里了。这里`data`即表示指向的地址，而且可以看到`AppDelegate`和`TestClass1`同样存在于`classlist`中。通过查找可以看到是在`__DATA_objcdata`这一个`section`中，这里真正保存了`class`的信息。

![image-20200204000858831](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200204000858831.png)

其实通过`runtime`源码`realizeAllClassesInImage`这里也可看到就是依次根据`classlist`找到对应的`objc_data`指针位移，然后根据`objc_class`的结构进行初始化：

```c++
static void realizeAllClassesInImage(header_info *hi)
{
    runtimeLock.assertWriting();

    size_t count, i;
    classref_t *classlist;

    if (hi->areAllClassesRealized()) return;
		//获取classlist指针列表
    classlist = _getObjc2ClassList(hi, &count);

    for (i = 0; i < count; i++) {
        // 依次根据mach-o中的信息对class进行初始化
        realizeClass(remapClass(classlist[i]));
    }

    hi->setAllClassesRealized(YES);
}
```

这里关于`runtime`就不多赘述，至少我们知道了`classlist`和`classref`的差集一定成都上反应了未使用的类，但是`mach-o View`并没有做好`classlist`的可视化，那么我们可以通过脚本来找出它们的差集，然后再定位是否确实未使用:

![image-20200204011616382](/Users/joey.cao/Library/Application Support/typora-user-images/image-20200204011616382.png)



### 清理掉无用的framework

在DJISDK的代码中有少量的`swift`代码存在，虽然打出的`Framework`看不出什么端倪，但是如果是一个纯OC的工程在引入`DJISDK`之后会被动加载



## 参考资料

https://github.com/huanxsd/LinkMap (一个用于解析linkmap的GUI工具)