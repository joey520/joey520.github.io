---
toc: true
title: MSDK包体积优化
date: 2020-02-03 22:20:58
categories: [iOS]
tags: [包体积,macho]
---

## 前言

MSDK作为一个第三方开发者依赖的动态库，包体积问题强行添加给了外部开发者。为此深入做了一系列的包体积优化。

<!--more-->

## 分析

包体积优化主要从几个方面入手，

1.源码层级，由于MSDK的代码经过几次大的版本迭代，导致很多历史遗留代码，而由于OC的动态特性，这些东西编译器是不会strip掉的。因此必须能从源码上找出这些未使用的类和代码。

2.资源层级，在MSDK的代码中使用了一些资源文件，例如限飞数据库等等，这些占用很大的空间。

3.库文件，在MSDK中也使用了一些第三方的开源库，然而并不是每一个库文件都是必须活着是有办法替代的。

4.代码结构，调整代码结构，避免冗余代码。

5.Swift代码，在MSDK的工程中存在少量的Swfit代码。这些代码在编译是会把swift标准库引入到最终用户打出的ipa。

### 去掉无用的类

要去掉无用的类可以通过静态扫描，也可以同`mach-O`做检查，后者效率更高，而且具有通用性，因此采用后者。

为了高效率和持久化。使用`python`脚本独立于工程之外，可以通过命令行执行。

经过扫描发现有100多个未使用的类，不过有一些是是特殊的类不能清理，所以需要手动过一遍，然后加入到白名单之中。

这一步之后最终打出包体积减少：

### 清理掉无用的framework

在DJISDK的代码中有少量的`swift`代码存在，虽然打出的`Framework`看不出什么端倪，但是如果是一个纯OC的工程在引入`DJISDK`之后会被动加载



## 参考资料

https://github.com/huanxsd/LinkMap (一个用于解析linkmap的GUI工具)